<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/png" href="images/logo/DCSS_Logo.jpg" />
    <title>Monthly Budgeting Tool</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        padding: 2rem;
      }

      .container {
        max-width: 1600px;
        margin: 0 auto;
        background: white;
        border-radius: 1rem;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 2rem;
        text-align: center;
      }

      .header h1 {
        font-size: 2rem;
        margin-bottom: 0.5rem;
      }

      .header p {
        opacity: 0.9;
        font-size: 1rem;
      }

      .controls {
        padding: 2rem;
        background: #f8f9fa;
        border-bottom: 2px solid #e9ecef;
      }

      .control-group {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
        margin-bottom: 1.5rem;
      }

      .control-item {
        display: flex;
        flex-direction: column;
      }

      .control-item label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #495057;
        font-size: 0.875rem;
      }

      .control-item input {
        padding: 0.75rem;
        border: 2px solid #dee2e6;
        border-radius: 0.5rem;
        font-size: 1rem;
        transition: border-color 0.3s;
      }

      .control-item input[type="month"] {
        min-width: 180px;
        cursor: pointer;
      }

      .control-item input:focus {
        outline: none;
        border-color: #667eea;
      }

      .btn-group {
        display: flex;
        gap: 1rem;
        justify-content: center;
      }

      .btn {
        padding: 0.875rem 1rem;
        border: none;
        border-radius: 0.5rem;
        font-size: 1rem;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      .btn:hover {
        transform: translateY(-2px);
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .btn-primary:hover {
        box-shadow: 0 10px 20px rgba(102, 126, 234, 0.4);
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-secondary:hover {
        background: #5a6268;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn-success:hover {
        background: #218838;
      }

      .summary {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1rem;
        max-width: 1400px;
        width: 100%;
        margin: 1rem auto;
      }

      .summary-card {
        padding: 1.5rem;
        border-radius: 0.75rem;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.15);
        text-align: center;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .summary-card .label {
        font-size: 0.875rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
      }

      .summary-card .value {
        font-size: 1.75rem;
        font-weight: 700;
      }

      .summary-card.positive .value {
        color: #28a745;
      }

      .summary-card.negative .value {
        color: #dc3545;
      }

      .summary-card.warning .value {
        color: #ffc107;
      }

      .summary-card:hover {
        transform: translateY(-8px) scale(1.02);
        filter: brightness(1.15);
        box-shadow: 0 12px 24px rgba(0, 0, 0, 0.25);
      }

      .content {
        padding: 0.5rem;
      }

      .paycheck-section {
        margin-bottom: 2rem;
      }

      .paycheck-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1.25rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-radius: 0.75rem;
        margin-bottom: 1rem;
      }

      .paycheck-header h2 {
        font-size: 1.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
      }

      .paycheck-info {
        text-align: right;
      }

      .paycheck-amount {
        font-size: 1.75rem;
        font-weight: bold;
      }

      .paycheck-remaining {
        font-size: 1rem;
        opacity: 0.9;
      }

      .bills-table {
        width: 100%;
        border-collapse: collapse;
        background: white;
        border-radius: 0.75rem;
        overflow: hidden;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      }

      .bills-table thead {
        background: #f8f9fa;
      }

      .bills-table th {
        padding: 1rem;
        text-align: left;
        font-weight: 600;
        color: #495057;
        border-bottom: 2px solid #dee2e6;
      }

      .bills-table td {
        padding: 1rem;
        border-bottom: 1px solid #e9ecef;
      }

      .bills-table tr:hover {
        background: #f8f9fa;
      }

      .bill-name {
        font-weight: 600;
        color: #212529;
      }

      .bill-category {
        font-size: 0.875rem;
        color: #6c757d;
        font-style: italic;
      }

      .amount {
        font-weight: 600;
        color: #dc3545;
      }

      .balance {
        color: #6c757d;
      }

      .due-date {
        font-weight: 600;
        color: #667eea;
      }

      .badge {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-size: 0.75rem;
        font-weight: 600;
        text-transform: uppercase;
      }

      .badge-ach {
        background: #d1ecf1;
        color: #0c5460;
      }

      .badge-up {
        background: #d4edda;
        color: #155724;
      }

      .badge-cl {
        background: #fff3cd;
        color: #856404;
      }

      .badge-priority {
        background: #f8d7da;
        color: #721c24;
      }

      .priority-high {
        color: #dc3545;
        font-weight: bold;
      }

      .priority-medium {
        color: #fd7e14;
        font-weight: 600;
      }

      .priority-low {
        color: #17a2b8;
        font-weight: 600;
      }

      .totals-row {
        background: #f8f9fa;
        font-weight: bold;
      }

      .totals-row td {
        border-top: 3px solid #667eea;
        padding: 1.5rem 1rem;
      }

      .recommendations {
        margin-top: 2rem;
        padding: 1.5rem;
        background: #e7f3ff;
        border-left: 4px solid #2196f3;
        border-radius: 0.5rem;
      }

      .recommendations h3 {
        color: #1976d2;
        margin-bottom: 1rem;
      }

      .recommendations ul {
        list-style-position: inside;
        color: #495057;
      }

      .recommendations li {
        padding: 0.5rem 0;
      }

      .alert {
        padding: 1rem 1.5rem;
        margin: 1rem 0;
        border-radius: 0.5rem;
        display: flex;
        align-items: center;
        gap: 1rem;
      }

      .alert-warning {
        background: #fff3cd;
        border-left: 4px solid #ffc107;
        color: #856404;
      }

      .alert-danger {
        background: #f8d7da;
        border-left: 4px solid #dc3545;
        color: #721c24;
      }

      .alert-success {
        background: #d4edda;
        border-left: 4px solid #28a745;
        color: #155724;
      }

      .icon {
        font-size: 1.5rem;
      }

      .payment-status-dropdown {
        padding: 0.5rem;
        border: 2px solid #dee2e6;
        border-radius: 0.375rem;
        font-size: 0.875rem;
        background: white;
        cursor: pointer;
        transition: border-color 0.3s;
        min-width: 150px;
      }

      .payment-status-dropdown:focus {
        outline: none;
        border-color: #667eea;
      }

      .payment-status-dropdown option[value="NP"] {
        color: #dc3545;
      }

      .payment-status-dropdown option[value="PNC"] {
        color: #ffc107;
      }

      .payment-status-dropdown option[value="PCL"] {
        color: #28a745;
      }

      .payment-status-dropdown option[value="REMOVE"] {
        color: #004085;
        font-weight: bold;
      }

      .bill-row-removed {
        display: none !important;
      }

      /* Apply colors to the select element based on selected value */
      .payment-status-dropdown[data-status="NP"] {
        color: #dc3545;
        font-weight: 600;
      }

      .payment-status-dropdown[data-status="PNC"] {
        color: #ffc107;
        font-weight: 600;
      }

      .payment-status-dropdown[data-status="PCL"] {
        color: #28a745;
        font-weight: 600;
      }

      .btn-delete-bill {
        background: transparent;
        border: none;
        font-size: 1.2rem;
        cursor: pointer;
        opacity: 0.6;
        transition: opacity 0.2s, transform 0.2s;
        padding: 0.25rem 0.5rem;
      }

      .btn-delete-bill:hover {
        opacity: 1;
        transform: scale(1.2);
      }

      @media print {
        body {
          background: white;
          padding: 0;
        }
        .controls,
        .btn-group {
          display: none;
        }
      }
      /* Responsive Misc/Unforeseen row styling */
      @media (max-width: 900px) {
        td.misc-unforeseen {
          padding: 0.5rem !important;
        }
        td.misc-unforeseen > div {
          flex-direction: column !important;
          gap: 0.5rem !important;
        }
      }
      @media (max-width: 600px) {
        td.misc-unforeseen {
          padding: 0.25rem !important;
        }
        td.misc-unforeseen > div {
          flex-direction: column !important;
          gap: 0.25rem !important;
        }
        td.misc-unforeseen input,
        td.misc-unforeseen button {
          width: 100% !important;
          min-width: 0 !important;
          font-size: 0.95rem !important;
        }
      }
      /* Responsive Design */
      @media (max-width: 1200px) {
        .container {
          max-width: 98vw;
          padding: 0.5rem;
        }
        .summary {
          max-width: 98vw;
        }
      }

      @media (max-width: 900px) {
        .controls {
          padding: 1rem;
        }
        .summary {
          grid-template-columns: 1fr;
          gap: 1rem;
        }
        .paycheck-header {
          flex-direction: column;
          align-items: flex-start;
          padding: 1rem;
        }
        .paycheck-header h2 {
          font-size: 1.2rem;
        }
        .paycheck-info {
          text-align: left;
        }
        .control-group {
          grid-template-columns: 1fr;
          gap: 1rem;
        }
        .btn-group {
          flex-direction: column;
          gap: 0.5rem;
        }
        .adjustmentsPanel,
        .savingsPanel {
          padding: 1rem;
        }
      }

      @media (max-width: 600px) {
        body {
          padding: 0.5rem;
        }
        .container {
          border-radius: 0.5rem;
          padding: 0.25rem;
        }
        .header {
          padding: 1rem;
        }
        .header h1 {
          font-size: 1.2rem;
        }
        .controls {
          padding: 0.5rem;
        }
        .control-group {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }
        .control-item input,
        .control-item select {
          font-size: 0.95rem;
          padding: 0.5rem;
        }
        .btn {
          font-size: 0.95rem;
          padding: 0.5rem 0.75rem;
          width: 100%;
        }
        .btn-group {
          flex-direction: column;
          gap: 0.5rem;
        }
        .summary {
          grid-template-columns: 1fr;
          gap: 0.5rem;
        }
        .summary-card {
          padding: 1rem;
          font-size: 1rem;
        }
        .paycheck-header {
          flex-direction: column;
          align-items: flex-start;
          padding: 0.5rem;
        }
        .bills-table th,
        .bills-table td {
          padding: 0.5rem;
          font-size: 0.85rem;
        }
        .bills-table {
          font-size: 0.85rem;
          overflow-x: auto;
          display: block;
        }
        .recommendations {
          padding: 0.5rem;
        }
        #addBillModal > div {
          padding: 1rem !important;
          max-width: 98vw !important;
        }
        #adjustmentsPanel,
        #savingsPanel {
          padding: 0.5rem !important;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="header">
        <h1>ðŸ’° Strickland's Monthly Budget App</h1>
        <p>Pay Off Your Debts</p>
      </div>

      <div class="controls">
        <div class="control-group">
          <div class="control-item">
            <label id="paydayLabel">Next Payday</label>
            <input type="date" id="DavidPayday" value="2025-11-21" />
            <small
              id="paydayWarning"
              style="color: #dc3545; display: none; margin-top: 0.25rem"
            ></small>
          </div>
          <div class="control-item">
            <label>David's Net Pay (Fridays - Biweekly)</label>
            <input type="number" id="DavidPay" value="3803.89" step="0.01" />
          </div>
          <div class="control-item">
            <label>Claudia's Net Pay (Tuesdays - Biweekly)</label>
            <input type="number" id="ClaudiaPay" value="1099.48" step="0.01" />
          </div>
          <div class="control-item">
            <label>Current Checking Balance</label>
            <div style="display: flex; gap: 0.5rem; align-items: center">
              <input
                type="number"
                id="bankBalance"
                value="1406.88"
                step="0.01"
                style="flex: 1"
              />
            </div>
          </div>
          <div class="control-item">
            <label for="monthYear">Month/Year</label>
            <input
              type="month"
              id="monthYear"
              name="monthYear"
              value="2025-11"
              style="width: 100%"
              aria-label="Select month and year"
              onfocus="checkMonthSupport(this)"
            />
            <!-- Firefox fallback -->
            <div
              id="monthYearFallback"
              style="display: none; flex-direction: row; gap: 0.5rem"
            >
              <select
                id="monthSelect"
                onchange="updateMonthYear()"
                style="
                  flex: 1;
                  padding: 0.75rem;
                  border: 2px solid #dee2e6;
                  border-radius: 0.5rem;
                  font-size: 1rem;
                "
              >
                <option value="01">January</option>
                <option value="02">February</option>
                <option value="03">March</option>
                <option value="04">April</option>
                <option value="05">May</option>
                <option value="06">June</option>
                <option value="07">July</option>
                <option value="08">August</option>
                <option value="09">September</option>
                <option value="10">October</option>
                <option value="11" selected>November</option>
                <option value="12">December</option>
              </select>
              <input
                type="number"
                id="yearSelect"
                onchange="updateMonthYear()"
                value="2025"
                min="2020"
                max="2050"
                style="
                  width: 100px;
                  padding: 0.75rem;
                  border: 2px solid #dee2e6;
                  border-radius: 0.5rem;
                  font-size: 1rem;
                "
              />
            </div>
          </div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="calculateBudget()">
            Calculate Alignment
          </button>

          <button class="btn btn-success" onclick="showAddBillForm()">
            âž• Add Expense
          </button>
          <button class="btn btn-success" onclick="addDeposit()">
            ðŸ’µ Add Deposit
          </button>
          <button class="btn btn-secondary" onclick="toggleAdjustments()">
            Adjust Bills
          </button>
          <button class="btn btn-secondary" onclick="toggleSavingsManager()">
            Manage Savings
          </button>
          <button class="btn btn-secondary" onclick="window.print()">
            Print Report
          </button>
        </div>
      </div>

      <!-- Add Bill Modal -->
      <div
        id="addBillModal"
        style="
          display: none;
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.5);
          z-index: 1000;
          justify-content: center;
          align-items: center;
        "
      >
        <div
          style="
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
          "
        >
          <h3 style="margin-top: 0">Add New Bill</h3>
          <form id="addBillForm" onsubmit="return false;">
            <div style="margin-bottom: 1rem">
              <label style="display: block; margin-bottom: 0.5rem"
                >Bill Name:</label
              >
              <input
                type="text"
                id="newBillName"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 2px solid #dee2e6;
                  border-radius: 0.375rem;
                "
              />
            </div>
            <div style="margin-bottom: 1rem">
              <label style="display: block; margin-bottom: 0.5rem"
                >Category:</label
              >
              <select
                id="newBillCategory"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 2px solid #dee2e6;
                  border-radius: 0.375rem;
                "
              >
                <option value="Main">Main</option>
                <option value="Credit Card">Credit Card</option>
                <option value="Utilities">Utilities</option>
                <option value="Budget">Budget</option>
                <option value="Subscription">Subscription</option>
              </select>
            </div>
            <div style="margin-bottom: 1rem">
              <label style="display: block; margin-bottom: 0.5rem"
                >Amount:</label
              >
              <input
                type="number"
                id="newBillAmount"
                step="0.01"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 2px solid #dee2e6;
                  border-radius: 0.375rem;
                "
              />
            </div>
            <div style="margin-bottom: 1rem">
              <label style="display: block; margin-bottom: 0.5rem"
                >Balance:</label
              >
              <input
                type="number"
                id="newBillBalance"
                step="0.01"
                value="0"
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 2px solid #dee2e6;
                  border-radius: 0.375rem;
                "
              />
            </div>
            <div style="margin-bottom: 1rem">
              <label style="display: block; margin-bottom: 0.5rem"
                >Due Day (1-31):</label
              >
              <input
                type="number"
                id="newBillDueDay"
                min="1"
                max="31"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 2px solid #dee2e6;
                  border-radius: 0.375rem;
                "
              />
            </div>
            <div style="margin-bottom: 1rem">
              <label style="display: block; margin-bottom: 0.5rem">Type:</label>
              <select
                id="newBillType"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 2px solid #dee2e6;
                  border-radius: 0.375rem;
                "
              >
                <option value="CL">CL - Credit Line</option>
                <option value="UP">UP - Utility/Payment</option>
                <option value="N">N - Non-debt</option>
              </select>
            </div>
            <div style="margin-bottom: 1rem">
              <label style="display: block; margin-bottom: 0.5rem"
                >Priority (1-4):</label
              >
              <input
                type="number"
                id="newBillPriority"
                min="1"
                max="4"
                value="2"
                required
                style="
                  width: 100%;
                  padding: 0.5rem;
                  border: 2px solid #dee2e6;
                  border-radius: 0.375rem;
                "
              />
            </div>
            <div style="margin-bottom: 1rem">
              <label style="display: flex; align-items: center; gap: 0.5rem">
                <input type="checkbox" id="newBillACH" />
                Auto-pay (ACH)
              </label>
            </div>
            <div style="display: flex; gap: 0.5rem; justify-content: flex-end">
              <button
                type="button"
                class="btn btn-secondary"
                onclick="hideAddBillForm()"
              >
                Cancel
              </button>
              <button
                type="button"
                class="btn btn-primary"
                onclick="addNewBill()"
              >
                Add Bill
              </button>
            </div>
          </form>
        </div>
      </div>

      <div
        id="adjustmentsPanel"
        style="
          display: none;
          padding: 2rem;
          background: #f8f9fa;
          border-bottom: 2px solid #e9ecef;
        "
      >
        <h3 style="margin-bottom: 1.5rem; color: #495057">
          ðŸ’° Adjust Monthly Amounts
        </h3>
        <div
          id="adjustableFields"
          style="
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
          "
        ></div>
        <div style="margin-top: 1.5rem; text-align: center">
          <button class="btn btn-primary" onclick="applyAdjustments()">
            Apply Changes
          </button>
          <button class="btn btn-secondary" onclick="toggleAdjustments()">
            Close
          </button>
        </div>
      </div>

      <div
        id="savingsPanel"
        style="
          display: none;
          padding: 2rem;
          background: #f8f9fa;
          border-bottom: 2px solid #e9ecef;
        "
      >
        <h3 style="margin-bottom: 1.5rem; color: #495057">
          ðŸ’µ Manage Surplus Savings
        </h3>
        <div style="max-width: 500px; margin: 0 auto">
          <div
            style="
              margin-bottom: 1.5rem;
              padding: 1rem;
              background: white;
              border-radius: 0.5rem;
              border: 2px solid #667eea;
            "
          >
            <div
              style="font-size: 0.875rem; color: #6c757d; margin-bottom: 0.5rem"
            >
              Current Balance
            </div>
            <div
              id="currentSavingsDisplay"
              style="font-size: 2rem; font-weight: bold; color: #667eea"
            >
              $0.00
            </div>
          </div>

          <div class="control-item" style="margin-bottom: 1rem">
            <label>Add/Subtract Amount</label>
            <input
              type="number"
              id="savingsAmount"
              placeholder="Enter amount"
              step="0.01"
              style="
                padding: 0.75rem;
                border: 2px solid #dee2e6;
                border-radius: 0.5rem;
                font-size: 1rem;
                width: 100%;
              "
            />
          </div>

          <div
            style="
              display: flex;
              gap: 1rem;
              flex-wrap: wrap;
              justify-content: center;
            "
          >
            <button class="btn btn-primary" onclick="addToSavings()">
              Add to Savings
            </button>
            <button class="btn btn-secondary" onclick="subtractFromSavings()">
              Withdraw
            </button>
            <button class="btn btn-secondary" onclick="resetSavings()">
              Reset to $0
            </button>
            <button class="btn btn-secondary" onclick="toggleSavingsManager()">
              Close
            </button>
          </div>
        </div>
      </div>

      <div id="results"></div>
    </div>

    <script>
      // ===== API Integration for Cloudflare D1 =====
      const API_BASE_URL = "/api/budget";
      const USER_ID = "default"; // In production, get this from authentication

      // API Helper Functions
      async function fetchBudgetData() {
        try {
          const response = await fetch(`${API_BASE_URL}?userId=${USER_ID}`);
          const result = await response.json();
          if (result.success) {
            return result.data;
          }
          throw new Error(result.error || "Failed to fetch data");
        } catch (error) {
          console.error("Error fetching budget data:", error);
          // Fallback to localStorage if API fails
          return {
            settings: {},
            billAdjustments: JSON.parse(
              localStorage.getItem("billAdjustments") || "{}"
            ),
            paymentStatuses: JSON.parse(
              localStorage.getItem("paymentStatuses") || "{}"
            ),
            miscExpenses: JSON.parse(
              localStorage.getItem("miscExpenses") || "{}"
            ),
            surplusSavings: parseFloat(
              localStorage.getItem("surplusSavings") || "0"
            ),
            deposits: JSON.parse(localStorage.getItem("deposits") || "{}"),
            bankBalance: localStorage.getItem("bankBalance"),
          };
        }
      }

      async function saveBudgetData(type, data) {
        try {
          const response = await fetch(API_BASE_URL, {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              userId: USER_ID,
              type,
              data,
            }),
          });
          const result = await response.json();
          if (!result.success) {
            throw new Error(result.error || "Failed to save data");
          }
          return true;
        } catch (error) {
          console.error("Error saving budget data:", error);
          // Fallback to localStorage if API fails
          switch (type) {
            case "bankBalance":
              localStorage.setItem("bankBalance", data.value);
              break;
            case "billAdjustments":
              localStorage.setItem("billAdjustments", JSON.stringify(data));
              break;
            case "paymentStatus":
              const statuses = JSON.parse(
                localStorage.getItem("paymentStatuses") || "{}"
              );
              statuses[`${data.year}-${data.month}-${data.billName}`] =
                data.status;
              localStorage.setItem("paymentStatuses", JSON.stringify(statuses));
              break;
            case "miscExpense":
              const misc = JSON.parse(
                localStorage.getItem("miscExpenses") || "{}"
              );
              misc[`${data.year}-${data.month}-Misc-${data.paycheckIndex}`] =
                data.data || data.amount; // Support both old (amount) and new (data object) format
              localStorage.setItem("miscExpenses", JSON.stringify(misc));
              break;
            case "deposit":
              const deposits = JSON.parse(
                localStorage.getItem("deposits") || "{}"
              );
              deposits[`${data.year}-${data.month}`] = data.data;
              localStorage.setItem("deposits", JSON.stringify(deposits));
              break;
            case "surplusSavings":
              localStorage.setItem("surplusSavings", data.amount.toString());
              break;
          }
          return false;
        }
      }

      // Global cache for budget data (refreshed from API)
      let budgetDataCache = {
        paymentStatuses: {},
        miscExpenses: {},
        surplusSavings: 0,
        deposits: {},
        customBills: [],
      };

      async function refreshBudgetDataCache() {
        const data = await fetchBudgetData();
        budgetDataCache = {
          paymentStatuses: data.paymentStatuses || {},
          miscExpenses: data.miscExpenses || {},
          surplusSavings: data.surplusSavings || 0,
          deposits: data.deposits || {},
          customBills: data.customBills || [],
        };
        return budgetDataCache;
      }

      // Bill data structure
      const billsData = [
        // Main Fixed Monthly Expenses
        {
          name: "Mortgage",
          category: "Main",
          amount: 2820.46,
          balance: 381561.09,
          dueDay: 15,
          ach: false,
          type: "CL",
          priority: 1,
        },
        {
          name: "Rent 17692",
          category: "Main",
          amount: 2395.0,
          balance: 0,
          dueDay: 1,
          ach: false,
          type: "CL",
          priority: 1,
        },
        {
          name: "Solar",
          category: "Main",
          amount: 164.55,
          balance: 164.55,
          dueDay: 21,
          ach: true,
          type: "UP",
          priority: 2,
        },
        {
          name: "Cellular",
          category: "Main",
          amount: 184.62,
          balance: 185.62,
          dueDay: 25,
          ach: true,
          type: "UP",
          priority: 2,
        },
        {
          name: "Car Payment",
          category: "Main",
          amount: 587.91,
          balance: 26859.43,
          dueDay: 19,
          ach: false,
          type: "UP",
          priority: 1,
        },
        {
          name: "Achieve Loan",
          category: "Main",
          amount: 1500.0,
          balance: 35801.26,
          dueDay: 15,
          ach: true,
          type: "N",
          priority: 1,
        },
        {
          name: "Sadzi School",
          category: "Main",
          amount: 0.0,
          balance: 2200.0,
          dueDay: 4,
          ach: false,
          type: "UP",
          priority: 2,
        },
        {
          name: "Auto Insurance",
          category: "Main",
          amount: 590.76,
          balance: 0,
          dueDay: 25,
          ach: true,
          type: "UP",
          priority: 1,
        },
        {
          name: "Achieve Loan 2",
          category: "Main",
          amount: 507.0,
          balance: 16300.0,
          dueDay: 30,
          ach: true,
          type: "CL",
          priority: 1,
        },

        // Credit Cards
        {
          name: "Amex",
          category: "Credit Card",
          amount: 0.0,
          balance: 0,
          dueDay: 17,
          ach: false,
          type: "CL",
          priority: 3,
        },
        {
          name: "Credit One 7801 Green",
          category: "Credit Card",
          amount: 500.0,
          balance: 1050.9,
          dueDay: 2,
          ach: false,
          type: "CL",
          priority: 2,
        },
        {
          name: "Credit One 3694 Blue",
          category: "Credit Card",
          amount: 0.0,
          balance: 0,
          dueDay: 23,
          ach: false,
          type: "CL",
          priority: 3,
        },
        {
          name: "Mercury Credit",
          category: "Credit Card",
          amount: 1769.08,
          balance: 2470.1,
          dueDay: 9,
          ach: false,
          type: "CL",
          priority: 2,
        },
        {
          name: "Quick Silver 9014",
          category: "Credit Card",
          amount: 0.0,
          balance: 0,
          dueDay: 21,
          ach: false,
          type: "CL",
          priority: 3,
        },
        {
          name: "Capital One Claudia",
          category: "Credit Card",
          amount: 159.41,
          balance: 0,
          dueDay: 23,
          ach: false,
          type: "CL",
          priority: 2,
        },
        {
          name: "Discover",
          category: "Credit Card",
          amount: 0.0,
          balance: 0,
          dueDay: 5,
          ach: false,
          type: "CL",
          priority: 3,
        },
        {
          name: "Home Depot",
          category: "Credit Card",
          amount: 0.0,
          balance: 0,
          dueDay: 20,
          ach: false,
          type: "CL",
          priority: 3,
        },
        {
          name: "Mariner Credit",
          category: "Credit Card",
          amount: 552.5,
          balance: 4185.82,
          dueDay: 9,
          ach: false,
          type: "CL",
          priority: 2,
        },
        {
          name: "Affirm",
          category: "Credit Card",
          amount: 266.73,
          balance: 800.18,
          dueDay: 10,
          ach: true,
          type: "CL",
          priority: 2,
        },
        {
          name: "Providence (ARSTRAT-Sugar)",
          category: "Credit Card",
          amount: 104.27,
          balance: 8507.0,
          dueDay: 26,
          ach: true,
          type: "N",
          priority: 2,
        },

        // Utilities (amounts are adjustable)
        {
          name: "Ziply",
          category: "Utilities",
          amount: 147.42,
          balance: 0,
          dueDay: 27,
          ach: false,
          type: "CL",
          priority: 2,
          adjustable: true,
        },
        {
          name: "Garbage",
          category: "Utilities",
          amount: 68.29,
          balance: 0,
          dueDay: 21,
          ach: false,
          type: "UP",
          priority: 2,
          adjustable: true,
        },
        {
          name: "NW Natural",
          category: "Utilities",
          amount: 35.73,
          balance: 0,
          dueDay: 9,
          ach: false,
          type: "CL",
          priority: 2,
          adjustable: true,
        },
        {
          name: "Portland General Electric (PGE)",
          category: "Utilities",
          amount: 266.09,
          balance: 0,
          dueDay: 15,
          ach: false,
          type: "CL",
          priority: 2,
          adjustable: true,
        },
        {
          name: "Water",
          category: "Utilities",
          amount: 0.0, // Bi-monthly - $0 for November
          balance: 0,
          dueDay: 20,
          ach: false,
          type: "CL",
          priority: 2,
          adjustable: true,
          bimonthly: true,
        },
        {
          name: "Blue Mountain",
          category: "Utilities",
          amount: 65.29,
          balance: 0,
          dueDay: 1,
          ach: true,
          type: "UP",
          priority: 2,
          adjustable: true,
        },
        {
          name: "Brooks Pest Service",
          category: "Utilities",
          amount: 109.0,
          balance: 0,
          dueDay: 8,
          ach: false,
          type: "UP",
          priority: 2,
          adjustable: true,
        },

        // Monthly Budget Items
        {
          name: "Groceries",
          category: "Budget",
          amount: 600.0,
          balance: 0,
          dueDay: 1, // Spread throughout month
          ach: false,
          type: "N",
          priority: 3,
          adjustable: true,
        },
        {
          name: "Lunch/Eating Out",
          category: "Budget",
          amount: 200.0,
          balance: 0,
          dueDay: 1,
          ach: false,
          type: "N",
          priority: 3,
          adjustable: true,
        },
        {
          name: "Gas (2 Vehicles)",
          category: "Budget",
          amount: 300.0,
          balance: 0,
          dueDay: 1,
          ach: false,
          type: "N",
          priority: 3,
          adjustable: true,
        },
        {
          name: "Budget Surplus/Savings",
          category: "Budget",
          amount: 1000.0,
          balance: 0,
          dueDay: 30, // End of month
          ach: false,
          type: "N",
          priority: 4,
          adjustable: true,
        },
      ];

      function toggleAdjustments() {
        const panel = document.getElementById("adjustmentsPanel");
        if (panel.style.display === "none") {
          // Show panel and populate fields for ALL bills
          const fieldsContainer = document.getElementById("adjustableFields");
          fieldsContainer.innerHTML = "";

          // Group bills by category
          const categories = {
            Main: [],
            "Credit Card": [],
            Utilities: [],
            Budget: [],
            Subscription: [],
          };

          billsData.forEach((bill) => {
            if (categories[bill.category]) {
              categories[bill.category].push(bill);
            }
          });

          // Render bills by category
          Object.keys(categories).forEach((category) => {
            if (categories[category].length > 0) {
              fieldsContainer.innerHTML += `
                <div style="margin-bottom: 1.5rem;">
                  <h4 style="color: #667eea; margin-bottom: 0.75rem; font-size: 1rem; border-bottom: 2px solid #667eea; padding-bottom: 0.25rem;">${category}</h4>
                  <div class="control-group">
              `;

              categories[category].forEach((bill, index) => {
                const fieldHTML = `
                  <div class="control-item">
                    <label>${bill.name}${
                  bill.bimonthly ? " (Bi-monthly)" : ""
                }</label>
                    <input type="number" id="adjust_${
                      bill.name
                    }" value="${bill.amount.toFixed(2)}" step="0.01" 
                           data-bill-name="${
                             bill.name
                           }" style="padding: 0.75rem; border: 2px solid #dee2e6; border-radius: 0.5rem; font-size: 1rem;">
                  </div>
                `;
                fieldsContainer.innerHTML += fieldHTML;
              });

              fieldsContainer.innerHTML += `
                  </div>
                </div>
              `;
            }
          });

          panel.style.display = "block";
        } else {
          panel.style.display = "none";
        }
      }

      async function applyAdjustments() {
        // Update bill amounts based on input fields
        const adjustments = {};
        const inputs = document.querySelectorAll('[id^="adjust_"]');
        inputs.forEach((input) => {
          const billName = input.dataset.billName;
          const newAmount = parseFloat(input.value) || 0;
          const bill = billsData.find((b) => b.name === billName);
          if (bill) {
            bill.amount = newAmount;
            adjustments[billName] = newAmount;
          }
        });

        // Save adjustments to API
        await saveBudgetData("billAdjustments", adjustments);

        // Recalculate budget
        calculateBudget();

        // Close panel
        toggleAdjustments();
      }

      async function loadSavedAdjustments() {
        // Load adjustments from API
        const data = await fetchBudgetData();
        const adjustments = data.billAdjustments || {};

        if (Object.keys(adjustments).length > 0) {
          try {
            Object.keys(adjustments).forEach((billName) => {
              const bill = billsData.find((b) => b.name === billName);
              if (bill) {
                bill.amount = adjustments[billName];
              }
            });
          } catch (e) {
            console.error("Error loading saved adjustments:", e);
          }
        }
      }

      async function toggleSavingsManager() {
        const panel = document.getElementById("savingsPanel");
        if (panel.style.display === "none") {
          // Show panel and update display
          const data = await fetchBudgetData();
          const currentSavings = data.surplusSavings || 0;
          document.getElementById("currentSavingsDisplay").textContent =
            "$" +
            currentSavings.toLocaleString("en-US", {
              minimumFractionDigits: 2,
              maximumFractionDigits: 2,
            });
          panel.style.display = "block";
        } else {
          panel.style.display = "none";
        }
      }

      async function addToSavings() {
        const amount =
          parseFloat(document.getElementById("savingsAmount").value) || 0;
        if (amount <= 0) {
          alert("Please enter a valid positive amount");
          return;
        }

        const data = await fetchBudgetData();
        const currentSavings = data.surplusSavings || 0;
        const newSavings = currentSavings + amount;
        await saveBudgetData("surplusSavings", { amount: newSavings });

        document.getElementById("currentSavingsDisplay").textContent =
          "$" +
          newSavings.toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        document.getElementById("savingsAmount").value = "";

        // Recalculate to update the summary card
        calculateBudget();
      }

      async function subtractFromSavings() {
        const amount =
          parseFloat(document.getElementById("savingsAmount").value) || 0;
        if (amount <= 0) {
          alert("Please enter a valid positive amount");
          return;
        }

        const data = await fetchBudgetData();
        const currentSavings = data.surplusSavings || 0;
        const newSavings = Math.max(0, currentSavings - amount);
        await saveBudgetData("surplusSavings", { amount: newSavings });

        document.getElementById("currentSavingsDisplay").textContent =
          "$" +
          newSavings.toLocaleString("en-US", {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2,
          });
        document.getElementById("savingsAmount").value = "";

        // Recalculate to update the summary card
        calculateBudget();
      }

      // Bill management functions
      function showAddBillForm() {
        document.getElementById("addBillModal").style.display = "flex";
      }

      function hideAddBillForm() {
        document.getElementById("addBillModal").style.display = "none";
        document.getElementById("addBillForm").reset();
      }

      async function addNewBill() {
        const billData = {
          name: document.getElementById("newBillName").value.trim(),
          category: document.getElementById("newBillCategory").value,
          amount:
            parseFloat(document.getElementById("newBillAmount").value) || 0,
          balance:
            parseFloat(document.getElementById("newBillBalance").value) || 0,
          dueDay: parseInt(document.getElementById("newBillDueDay").value) || 1,
          ach: document.getElementById("newBillACH").checked,
          type: document.getElementById("newBillType").value,
          priority:
            parseInt(document.getElementById("newBillPriority").value) || 1,
        };

        // Validate inputs
        if (!billData.name) {
          alert("Please enter a bill name");
          return;
        }
        if (billData.amount <= 0) {
          alert("Please enter a valid amount");
          return;
        }

        try {
          await saveBudgetData("addBill", billData);
          await refreshBudgetDataCache();
          calculateBudget();
          hideAddBillForm();
          alert("Bill added successfully!");
        } catch (error) {
          alert("Failed to add bill: " + error.message);
        }
      }

      async function deleteBill(billId) {
        if (
          !confirm(
            "Archive this bill? It will be hidden from budget but kept for tax records."
          )
        ) {
          return;
        }

        try {
          await saveBudgetData("deleteBill", { billId });
          await refreshBudgetDataCache();
          calculateBudget();
        } catch (error) {
          alert("Failed to delete bill: " + error.message);
        }
      }

      async function resetSavings() {
        if (
          confirm(
            "Are you sure you want to reset David surplus savings balance to $0?"
          )
        ) {
          await saveBudgetData("surplusSavings", { amount: 0 });
          document.getElementById("currentSavingsDisplay").textContent =
            "$0.00";
          document.getElementById("savingsAmount").value = "";

          // Recalculate to update the summary card
          calculateBudget();
        }
      }

      function calculateBudget() {
        const DavidPaydayInput = document.getElementById("DavidPayday").value;
        const DavidPay = parseFloat(document.getElementById("DavidPay").value);
        const ClaudiaPay = parseFloat(
          document.getElementById("ClaudiaPay").value
        );
        const bankBalance = parseFloat(
          document.getElementById("bankBalance").value
        );
        const monthYearInput = document.getElementById("monthYear").value;

        const [year, month] = monthYearInput.split("-").map(Number);
        const DavidPayday = new Date(DavidPaydayInput);

        // Calculate all pay periods for the month
        const payPeriods = calculatePayPeriods(
          DavidPayday,
          year,
          month,
          DavidPay,
          ClaudiaPay
        );

        // Assign bills to pay periods
        const assignments = assignBillsToPayPeriods(payPeriods, year, month);

        // Render the results
        renderResults(assignments, payPeriods, year, month, bankBalance);
      }

      function calculatePayPeriods(
        firstPayday,
        year,
        month,
        DavidPay,
        ClaudiaPay
      ) {
        const periods = [];
        const startOfMonth = new Date(year, month - 1, 1);
        const endOfMonth = new Date(year, month, 0);

        console.log(`Calculating pay periods for ${month}/${year}`);
        console.log(
          `Month range: ${startOfMonth.toDateString()} to ${endOfMonth.toDateString()}`
        );

        // You get paid twice per month (Thursdays biweekly)
        // Claudia gets paid twice per month (Tuesdays biweekly, opposite weeks)
        const DavidReferencePayday = new Date(firstPayday);
        console.log(
          `David reference payday: ${DavidReferencePayday.toDateString()}`
        );

        // Start from well before the target month to ensure we catch all paychecks
        let DavidCurrentPayday = new Date(DavidReferencePayday);

        // Go back to find a starting point before the month begins
        // Go back enough weeks to ensure we find the first paycheck of any month
        while (DavidCurrentPayday > startOfMonth) {
          DavidCurrentPayday.setDate(DavidCurrentPayday.getDate() - 14);
        }
        console.log(
          `David starting search point: ${DavidCurrentPayday.toDateString()}`
        );

        // Collect all David paychecks that fall in the month
        const DavidPaychecks = [];
        while (DavidCurrentPayday <= endOfMonth) {
          if (
            DavidCurrentPayday >= startOfMonth &&
            DavidCurrentPayday <= endOfMonth
          ) {
            console.log(
              `Found David paycheck: ${DavidCurrentPayday.toDateString()}`
            );
            DavidPaychecks.push(new Date(DavidCurrentPayday));
          }
          DavidCurrentPayday.setDate(DavidCurrentPayday.getDate() + 14);
        }

        // Calculate Claudia's paychecks (Tuesdays)
        // Claudia gets paid on Tuesdays, you get paid on Thursdays
        // They're on opposite biweekly schedules
        const ClaudiaPaychecks = [];

        // Start from David reference payday, but go to the OPPOSITE week's Tuesday
        let ClaudiaCurrentPayday = new Date(DavidReferencePayday);

        // First, go back 2 days to get from Thursday to Tuesday
        ClaudiaCurrentPayday.setDate(ClaudiaCurrentPayday.getDate() - 2);

        // Then go back 7 days to get to the OPPOSITE week (since she's paid on off-weeks from you)
        ClaudiaCurrentPayday.setDate(ClaudiaCurrentPayday.getDate() - 7);

        // Go back to find starting point
        while (ClaudiaCurrentPayday > startOfMonth) {
          ClaudiaCurrentPayday.setDate(ClaudiaCurrentPayday.getDate() - 14);
        }
        console.log(
          `Claudia's starting search point: ${ClaudiaCurrentPayday.toDateString()}`
        );

        // Collect all Claudia's paychecks that fall in the month
        while (ClaudiaCurrentPayday <= endOfMonth) {
          if (
            ClaudiaCurrentPayday >= startOfMonth &&
            ClaudiaCurrentPayday <= endOfMonth
          ) {
            console.log(
              `Found Claudia paycheck: ${ClaudiaCurrentPayday.toDateString()}`
            );
            ClaudiaPaychecks.push(new Date(ClaudiaCurrentPayday));
          }
          ClaudiaCurrentPayday.setDate(ClaudiaCurrentPayday.getDate() + 14);
        }

        // Combine all paychecks
        const allPaychecks = [];

        DavidPaychecks.forEach((date) => {
          allPaychecks.push({
            date: date,
            amount: DavidPay,
            person: "David",
            bills: [],
            totalAssigned: 0,
          });
        });

        ClaudiaPaychecks.forEach((date) => {
          allPaychecks.push({
            date: date,
            amount: ClaudiaPay,
            person: "Claudia",
            bills: [],
            totalAssigned: 0,
          });
        });

        // Sort by date
        allPaychecks.sort((a, b) => a.date - b.date);

        // Remove any duplicates (shouldn't happen but just in case)
        const uniquePaychecks = [];
        const seenDates = new Set();

        allPaychecks.forEach((pc) => {
          const dateKey = pc.date.toISOString().split("T")[0] + pc.person;
          if (!seenDates.has(dateKey)) {
            seenDates.add(dateKey);
            uniquePaychecks.push(pc);
          }
        });

        return uniquePaychecks;
      }

      function assignBillsToPayPeriods(payPeriods, year, month) {
        const assignments = payPeriods.map((p) => ({ ...p, bills: [] }));

        // Get today's date for filtering already-paid bills
        const today = new Date();
        const isCurrentMonth =
          year === today.getFullYear() && month === today.getMonth() + 1;

        // Merge hardcoded bills with custom bills from database (excluding soft-deleted)
        const allBills = [
          ...billsData,
          ...budgetDataCache.customBills
            .filter((bill) => !bill.deleted)
            .map((bill) => ({ ...bill, custom: true })),
        ];

        // Filter bills with non-zero amounts only
        // Keep all bills with amount > 0 regardless of due date
        let activeBills = allBills.filter((bill) => bill.amount > 0);

        // Sort bills by priority (1 = highest) then by due date
        const sortedBills = [...activeBills].sort((a, b) => {
          if (a.priority !== b.priority) return a.priority - b.priority;
          return a.dueDay - b.dueDay;
        });

        // Separate budget items that should be split across all paychecks
        const budgetItemsToSplit = sortedBills.filter(
          (bill) =>
            bill.category === "Budget" &&
            (bill.name === "Groceries" ||
              bill.name === "Lunch/Eating Out" ||
              bill.name === "Gas (2 Vehicles)")
        );

        const otherBills = sortedBills.filter(
          (bill) =>
            !(
              bill.category === "Budget" &&
              (bill.name === "Groceries" ||
                bill.name === "Lunch/Eating Out" ||
                bill.name === "Gas (2 Vehicles)")
            )
        );

        // Assign regular bills to the appropriate pay period
        otherBills.forEach((bill) => {
          const dueDate = new Date(year, month - 1, bill.dueDay);

          // Find the best pay period (last payday before or on due date)
          let bestPeriodIndex = -1;
          let minDaysDiff = Infinity;

          assignments.forEach((period, index) => {
            const daysDiff = Math.floor(
              (dueDate - period.date) / (1000 * 60 * 60 * 24)
            );

            // Prefer paying from a paycheck that comes before the due date
            // but is closest to it (within 0-14 days before due date ideally)
            if (daysDiff >= 0 && daysDiff < minDaysDiff) {
              minDaysDiff = daysDiff;
              bestPeriodIndex = index;
            }
          });

          // If no period found before due date, assign to earliest period
          if (bestPeriodIndex === -1) {
            bestPeriodIndex = 0;
          }

          // Assign bill to the period
          assignments[bestPeriodIndex].bills.push({
            ...bill,
            dueDate: dueDate,
          });
          assignments[bestPeriodIndex].totalAssigned += bill.amount;
        });

        // Distribute budget items evenly across all paychecks
        budgetItemsToSplit.forEach((bill) => {
          const amountPerPaycheck = bill.amount / assignments.length;

          assignments.forEach((period) => {
            period.bills.push({
              ...bill,
              amount: amountPerPaycheck,
              dueDate: period.date, // Use the paycheck date as the "due date" for budget items
              splitItem: true,
            });
            period.totalAssigned += amountPerPaycheck;
          });
        });

        return assignments;
      }

      function renderResults(
        assignments,
        payPeriods,
        year,
        month,
        bankBalance
      ) {
        const resultsDiv = document.getElementById("results");

        // Check if viewing current month
        const today = new Date();
        today.setHours(0, 0, 0, 0); // Reset time to start of day for comparison
        const isCurrentMonth =
          year === today.getFullYear() && month === today.getMonth() + 1;

        // Calculate summary statistics
        // Rental income (received on 1st of every month)
        const rentalIncome = 2940.0;

        // Total income = sum of all paychecks in the month (4 total: you 2x, Claudia 2x) + rental income
        const paychecksIncome = assignments.reduce(
          (sum, p) => sum + p.amount,
          0
        );
        const totalIncome = paychecksIncome + rentalIncome;

        // Remaining income = sum of paychecks that haven't been received yet (date >= today)
        const remainingIncome = isCurrentMonth
          ? assignments
              .filter((p) => p.date >= today)
              .reduce((sum, p) => sum + p.amount, 0)
          : totalIncome;

        // For current month: only count expenses from future paychecks
        // For future months: count all expenses
        const totalExpenses = isCurrentMonth
          ? assignments
              .filter((p) => p.date >= today)
              .reduce((sum, p) => sum + p.totalAssigned, 0)
          : assignments.reduce((sum, p) => sum + p.totalAssigned, 0);

        const netCashFlow = remainingIncome - totalExpenses;
        const totalDebt = billsData.reduce((sum, b) => sum + b.balance, 0);

        // Calculate adjusted bank balance (subtracting paid bills) - needed for projectedBalance
        const adjustedBankBalance = calculateAdjustedBankBalance();
        const totalPaidBills = bankBalance - adjustedBankBalance;

        // Projected balance should use adjusted balance (not raw balance)
        // because adjusted balance already accounts for paid bills
        const projectedBalance =
          adjustedBankBalance + remainingIncome - totalExpenses;

        console.log("=== CALCULATION BREAKDOWN ===");
        console.log("Is Current Month:", isCurrentMonth);
        console.log("Today's Date:", today.toDateString());
        console.log("");
        console.log("--- INCOME ---");
        console.log(
          "Total Income (all paychecks in month):",
          totalIncome.toFixed(2)
        );
        console.log(
          "Remaining Income (future paychecks only):",
          remainingIncome.toFixed(2)
        );
        console.log("");
        console.log("--- EXPENSES ---");
        console.log(
          "Total Expenses (bills assigned to future paychecks):",
          totalExpenses.toFixed(2)
        );
        console.log("");
        console.log("--- RESULTS ---");
        console.log("Bank Balance (raw):", bankBalance.toFixed(2));
        console.log(
          "Bank Balance (adjusted after paid bills):",
          adjustedBankBalance.toFixed(2)
        );
        console.log("Total Paid Bills:", totalPaidBills.toFixed(2));
        console.log("");
        console.log("NET CASH FLOW = Remaining Income - Total Expenses");
        console.log(
          `NET CASH FLOW = ${remainingIncome.toFixed(
            2
          )} - ${totalExpenses.toFixed(2)} = ${netCashFlow.toFixed(2)}`
        );
        console.log("");
        console.log(
          "PROJECTED BALANCE = Adjusted Bank Balance + Remaining Income - Remaining Expenses"
        );
        console.log(
          `PROJECTED BALANCE = ${adjustedBankBalance.toFixed(
            2
          )} + ${remainingIncome.toFixed(2)} - ${totalExpenses.toFixed(
            2
          )} = ${projectedBalance.toFixed(2)}`
        );
        console.log("");
        console.log(
          "DIFFERENCE = Projected Balance - Net Cash Flow = Adjusted Bank Balance"
        );
        console.log(
          `DIFFERENCE = ${projectedBalance.toFixed(2)} - ${netCashFlow.toFixed(
            2
          )} = ${(projectedBalance - netCashFlow).toFixed(2)}`
        );
        console.log("=== END BREAKDOWN ===");
        console.log("");

        // Calculate how many paychecks for each person (total)
        const DavidPaychecksTotal = assignments.filter(
          (p) => p.person === "David"
        ).length;
        const ClaudiaPaychecksTotal = assignments.filter(
          (p) => p.person === "Claudia"
        ).length;

        // Calculate remaining paychecks (not yet received)
        const DavidPaychecksRemaining = isCurrentMonth
          ? assignments.filter((p) => p.person === "David" && p.date >= today)
              .length
          : DavidPaychecksTotal;
        const ClaudiaPaychecksRemaining = isCurrentMonth
          ? assignments.filter((p) => p.person === "Claudia" && p.date >= today)
              .length
          : ClaudiaPaychecksTotal;

        // Calculate surplus savings for this month
        const surplusBill = billsData.find(
          (b) => b.name === "Budget Surplus/Savings"
        );
        const monthlySurplus = surplusBill ? surplusBill.amount : 0;

        // Get accumulated savings from cache
        let accumulatedSavings = budgetDataCache.surplusSavings || 0;

        // Calculate total misc spending for current month/year being viewed
        let totalMiscSpending = 0;
        Object.keys(budgetDataCache.miscExpenses).forEach((key) => {
          const parts = key.split("-");
          const keyYear = parseInt(parts[0]);
          const keyMonth = parseInt(parts[1]);
          if (keyYear === year && keyMonth === month) {
            const miscData = budgetDataCache.miscExpenses[key];
            // Handle both old format (number) and new format (object with total)
            totalMiscSpending +=
              typeof miscData === "number" ? miscData : miscData.total || 0;
          }
        });

        // Calculate total deposits for current month/year being viewed
        let totalMonthlyDeposits = 0;
        const depositsKey = `${year}-${month}`;
        if (budgetDataCache.deposits && budgetDataCache.deposits[depositsKey]) {
          const depositData = budgetDataCache.deposits[depositsKey];
          totalMonthlyDeposits = depositData.total || 0;
        }

        let html = `
                	
				<div class="summary">
					<div class="summary-card" style="background: #4CAF50; color: white;">
						<div class="label" style="color: white; font-weight: 600;">ðŸ’µ Total Monthly Income</div>
						<div class="value" style="color: white;">$${totalIncome.toFixed(2)}</div>
						<div style="font-size: 0.75rem; color: rgba(255,255,255,0.95); margin-top: 0.25rem;">
							David: ${DavidPaychecksTotal}x | Claudia: ${ClaudiaPaychecksTotal}x paychecks + Rental
						</div>
					</div>
					<div class="summary-card" style="background: #E91E63; color: white;">
						<div class="label" style="color: white; font-weight: 600;">ðŸ  Rental Income</div>
						<div class="value" style="color: white; font-weight: 700;">$${rentalIncome.toFixed(
              2
            )}</div>
						<div style="font-size: 0.75rem; color: rgba(255,255,255,0.95); margin-top: 0.25rem;">
							Received on 1st of month
						</div>
					</div>
					${
            isCurrentMonth
              ? `
					<div class="summary-card" style="background: #5C9FD8; color: white;">
						<div class="label" style="color: white; font-weight: 600;">ðŸ¦ Current Checking Balance</div>
						<div class="value" style="color: white;">$${adjustedBankBalance.toFixed(
              2
            )}</div>
						${
              totalPaidBills > 0
                ? `
						<div style="font-size: 0.75rem; color: rgba(255,255,255,0.95); margin-top: 0.25rem;">
							Base: $${bankBalance.toFixed(2)} - Paid: $${totalPaidBills.toFixed(2)}
						</div>
						`
                : ""
            }
					</div>
					<div class="summary-card" style="background: #FF9800; color: white;">
						<div class="label" style="color: white; font-weight: 600;">ðŸ’¸ Remaining Monthly Income</div>
						<div class="value" style="color: white;">$${remainingIncome.toFixed(2)}</div>
						<div style="font-size: 0.75rem; color: rgba(255,255,255,0.95); margin-top: 0.25rem;">
							David: ${DavidPaychecksRemaining}x | Claudia: ${ClaudiaPaychecksRemaining}x left
						</div>
					</div>
					`
              : ""
          }
					<div class="summary-card" style="background: #CE6BA4; color: white;">
						<div class="label" style="color: white; font-weight: 600;">ðŸ“‹ ${
              isCurrentMonth ? "Remaining " : "Total "
            }Bills</div>
						<div class="value" style="color: white;">$${totalExpenses.toFixed(2)}</div>
					</div>
					<div class="summary-card" style="background: ${
            netCashFlow >= 0 ? "#4CAF50" : "#E91E63"
          }; color: white;">
						<div class="label" style="color: white; font-weight: 600;">ðŸ’¹ Net Cash Flow</div>
						<div class="value" style="color: white;">$${netCashFlow.toFixed(2)}</div>
					</div>
					<div class="summary-card" style="background: ${
            projectedBalance >= 0 ? "#66BB6A" : "#E91E63"
          }; color: white;">
						<div class="label" style="color: white; font-weight: 600;">ðŸ“Š Projected Balance</div>
						<div class="value" style="color: white;">$${projectedBalance.toFixed(2)}</div>
						<div style="font-size: 0.75rem; color: rgba(255,255,255,0.95); margin-top: 0.25rem;">
							After all bills paid
						</div>
					</div>
	
					</div>
					<div class="summary-card" style="background: #FDD835; color: white;">
						<div class="label" style="color: white; font-weight: 600;">ðŸ’° Monthly Misc Spending</div>
						<div class="value" style="color: white; font-weight: 700;">$${totalMiscSpending.toFixed(
              2
            )}</div>
						<div style="font-size: 0.75rem; color: rgba(255,255,255,0.95); margin-top: 0.25rem;">
							${new Date(year, month - 1).toLocaleString("default", {
                month: "long",
                year: "numeric",
              })}
						</div>
					</div>
					<div class="summary-card" style="background: #26A69A; color: white;">
						<div class="label" style="color: white; font-weight: 600;">ðŸ’µ Monthly Other Deposits</div>
						<div class="value" style="color: white; font-weight: 700;">$${totalMonthlyDeposits.toFixed(
              2
            )}</div>
						<div style="font-size: 0.75rem; color: rgba(255,255,255,0.95); margin-top: 0.25rem;">
							${new Date(year, month - 1).toLocaleString("default", {
                month: "long",
                year: "numeric",
              })}
						</div>
					</div>
					<div class="summary-card" style="background: #9C27B0; color: white;">
						<div class="label" style="color: white; font-weight: 600;">ðŸ’Ž Surplus Savings Balance</div>
						<div class="value" style="color: white;">$${accumulatedSavings.toLocaleString(
              "en-US",
              { minimumFractionDigits: 2 }
            )}</div>
						<div style="font-size: 0.75rem; color: rgba(255,255,255,0.95); margin-top: 0.25rem;">
							This month: $${monthlySurplus.toFixed(2)}
						</div>
					</div>
				</div>
								<div class="summary-card" style="background: #FF7043; color: white;">
						<div class="label" style="color: white; font-weight: 600;">ðŸ’³ Total Debt</div>
						<div class="value" style="color: white;">$${totalDebt.toLocaleString("en-US", {
              minimumFractionDigits: 2,
            })}</div>


			<!-- Deposit History Section -->
                ${
                  totalMonthlyDeposits > 0 &&
                  budgetDataCache.deposits[depositsKey]?.entries
                    ? `
                <div style="margin: 1.5rem 0; padding: 1rem; background: linear-gradient(135deg, #e8f5e9 0%, #c8e6c9 100%); border-radius: 0.5rem; border: 2px solid #28a745;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.75rem;">
                        <h3 style="margin: 0; color: #1b5e20; font-size: 1.125rem;">ðŸ’µ Deposit History - ${new Date(
                          year,
                          month - 1
                        ).toLocaleString("default", {
                          month: "long",
                          year: "numeric",
                        })}</h3>
                        <span style="font-weight: 700; color: #1b5e20; font-size: 1.25rem;">$${totalMonthlyDeposits.toFixed(
                          2
                        )}</span>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 0.5rem;">
                        ${budgetDataCache.deposits[depositsKey].entries
                          .sort(
                            (a, b) =>
                              new Date(b.timestamp) - new Date(a.timestamp)
                          )
                          .map(
                            (entry) => `
                            <div style="display: flex; justify-content: space-between; padding: 0.75rem; background: white; border-radius: 0.375rem; border: 1px solid #a5d6a7;">
                                <div style="flex: 1;">
                                    <span style="font-weight: 600; color: #1b5e20; font-size: 1rem;">$${entry.amount.toFixed(
                                      2
                                    )}</span>
                                    <span style="color: #2e7d32; margin-left: 0.75rem; font-size: 0.9rem;">${
                                      entry.comment || "No description"
                                    }</span>
                                </div>
                                <span style="color: #558b2f; font-size: 0.875rem; white-space: nowrap; margin-left: 1rem;">
                                    ${new Date(
                                      entry.timestamp
                                    ).toLocaleString()}
                                </span>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                </div>
                `
                    : ""
                }

                <div class="content">
            `;

        // Add alerts based on cash flow
        if (netCashFlow < 0) {
          html += `
                    <div class="alert alert-danger">
                        <span class="icon">âš ï¸</span>
                        <div>
                            <strong>Budget Deficit!</strong> David expenses exceed income by $${Math.abs(
                              netCashFlow
                            ).toFixed(2)}. 
                            Consider deferring non-essential payments or negotiating payment plans.
                        </div>
                    </div>
                `;
        } else if (netCashFlow > 0) {
          html += `
                    <div class="alert alert-success">
                        <span class="icon">âœ“</span>
                        <div>
                            <strong>Budget Surplus!</strong> You have $${netCashFlow.toFixed(
                              2
                            )} remaining after all bills. 
                            Consider applying this to David highest-interest debt.
                        </div>
                    </div>
                `;
        }

        // Render each pay period
        assignments.forEach((period, index) => {
          const remaining = period.amount - period.totalAssigned;
          const utilizationPercent = (
            (period.totalAssigned / period.amount) *
            100
          ).toFixed(1);

          html += `
                    <div class="paycheck-section">
                        <div class="paycheck-header">
                            <h2>
                                <span>ðŸ’µ</span>
                                Paycheck ${index + 1} - ${period.person}
                                <span style="font-size: 1rem; opacity: 0.9; font-weight: normal;">
                                    (${period.date.toLocaleDateString("en-US", {
                                      month: "short",
                                      day: "numeric",
                                      year: "numeric",
                                    })})
                                </span>
                            </h2>
                            <div class="paycheck-info">
                                <div class="paycheck-amount">$${period.amount.toFixed(
                                  2
                                )}</div>
                                <div class="paycheck-remaining" style="color: ${
                                  remaining >= 0 ? "#90EE90" : "#FFB6C6"
                                }">
                                    Remaining: $${remaining.toFixed(
                                      2
                                    )} (${utilizationPercent}% used)
                                </div>
                            </div>
                        </div>

                        <table class="bills-table">
                            <thead>
                                <tr>
                                    <th>Bill Name</th>
                                    <th>Category</th>
                                    <th>Due Date</th>
                                    <th>Amount</th>
                                    <th>Balance</th>
                                    <th>Payment Status</th>
                                    <th>Priority</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                `;

          // Sort bills by due date
          const sortedBills = [...period.bills].sort(
            (a, b) => a.dueDate - b.dueDate
          );

          const today = new Date();
          today.setHours(0, 0, 0, 0);

          sortedBills.forEach((bill) => {
            const daysToPay = Math.floor(
              (bill.dueDate - period.date) / (1000 * 60 * 60 * 24)
            );

            // Check if due date is within 3 days from today
            const daysUntilDue = Math.floor(
              (bill.dueDate - today) / (1000 * 60 * 60 * 24)
            );

            const priorityLabel =
              bill.priority === 1
                ? "High"
                : bill.priority === 2
                ? "Medium"
                : "Low";

            const priorityClass =
              bill.priority === 1
                ? "priority-high"
                : bill.priority === 2
                ? "priority-medium"
                : "priority-low";

            // Get saved payment status
            // For split bills, include the period index in the key
            const billKey = bill.splitItem
              ? `${year}-${month}-${bill.name}-${index}`
              : `${year}-${month}-${bill.name}`;
            const paymentStatus =
              budgetDataCache.paymentStatuses[billKey] || "NP";

            // Add class to hide row if status is REMOVE
            const rowClass =
              paymentStatus === "REMOVE" ? 'class="bill-row-removed"' : "";

            html += `
                        <tr ${rowClass}>
                            <td>
                                <div class="bill-name">${bill.name}</div>
                                ${
                                  daysUntilDue >= 0 && daysUntilDue <= 3
                                    ? '<span class="badge badge-priority">Due Soon</span>'
                                    : ""
                                }
                            </td>
                            <td><span class="bill-category">${
                              bill.category
                            }</span></td>
                            <td><span class="due-date">${bill.dueDate.toLocaleDateString(
                              "en-US",
                              { month: "short", day: "numeric" }
                            )}</span></td>
                            <td><span class="amount">$${bill.amount.toFixed(
                              2
                            )}</span></td>
                            <td><span class="balance">$${bill.balance.toLocaleString(
                              "en-US",
                              { minimumFractionDigits: 2 }
                            )}</span></td>
                            <td>
                                <select class="payment-status-dropdown" 
                                        data-bill-key="${billKey}"
                                        data-bill-amount="${bill.amount}"
                                        data-status="${paymentStatus}"
                                        onchange="updatePaymentStatus(this)">
                                    <option value="NP" ${
                                      paymentStatus === "NP" ? "selected" : ""
                                    }>NP - Not Paid</option>
                                    <option value="PNC" ${
                                      paymentStatus === "PNC" ? "selected" : ""
                                    }>PNC - Paid (Not Cleared)</option>
                                    <option value="PCL" ${
                                      paymentStatus === "PCL" ? "selected" : ""
                                    }>PCL - Paid & Cleared</option>
                                    <option value="REMOVE" ${
                                      paymentStatus === "REMOVE"
                                        ? "selected"
                                        : ""
                                    }>Remove</option>
                                </select>
                            </td>
                            <td><span class="${priorityClass}">${priorityLabel}</span></td>
                            <td>
                                ${
                                  bill.custom
                                    ? `<button class="btn-delete-bill" onclick="deleteBill(${bill.id})" title="Archive Bill">ðŸ—‘ï¸</button>`
                                    : ""
                                }
                            </td>
                        </tr>
                    `;
          });

          // Add Misc row
          const miscKey = `${year}-${month}-Misc-${index}`;
          const rawMiscData = budgetDataCache.miscExpenses[miscKey];

          // Ensure proper data structure - handle both old (number) and new (object) format
          let miscData;
          if (typeof rawMiscData === "number") {
            // Old format: just a number
            miscData = { total: rawMiscData, entries: [] };
          } else if (rawMiscData && typeof rawMiscData === "object") {
            // New format: object with total and entries
            miscData = {
              total: rawMiscData.total || 0,
              entries: Array.isArray(rawMiscData.entries)
                ? rawMiscData.entries
                : [],
            };
          } else {
            // No data
            miscData = { total: 0, entries: [] };
          }

          const miscAmount = miscData.total || 0;

          html += `
                        <tr style="background: #fff9e6; border-top: 2px solid #ffc107;">
                          <td colspan="7" class="misc-unforeseen">
                            <div style="padding: 0.5rem; display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                    <div class="bill-name" style="color: #856404; margin-bottom: 0.75rem;">
                                        ðŸ’° Misc/Unforeseen - Week ${index + 1}
                                        ${
                                          miscAmount > 0
                                            ? `<span style="font-weight: 700; margin-left: 0.5rem;">Total: $${miscAmount.toFixed(
                                                2
                                              )}</span>`
                                            : ""
                                        }
                                    </div>
                                    <div style="display: flex; gap: 0.5rem; align-items: flex-start; flex-wrap: wrap;">
                                        <input type="number" 
                                               id="misc-input-${miscKey}"
                                               class="misc-amount-input" 
                                               data-misc-key="${miscKey}"
                                               value="0.00" 
                                               step="0.01"
                                               min="0"
                                               placeholder="Amount"
                                               style="width: 120px; padding: 0.5rem; border: 2px solid #ffc107; border-radius: 0.375rem; font-size: 0.875rem;">
                                        <input type="text"
                                               id="misc-comment-${miscKey}"
                                               placeholder="What was this for? (e.g., Gas, Groceries)"
                                               style="flex: 1; min-width: 200px; padding: 0.5rem; border: 2px solid #ffc107; border-radius: 0.375rem; font-size: 0.875rem;">
                                        <button type="button" onclick="submitMiscAmount('${miscKey}')" 
                                                style="padding: 0.5rem 1rem; background: #ffc107; color: #856404; border: none; border-radius: 0.375rem; font-weight: 600; cursor: pointer; font-size: 0.875rem; white-space: nowrap;"
                                                onmouseover="this.style.background='#e0a800'" 
                                                onmouseout="this.style.background='#ffc107'">
                                            Add Expense
                                        </button>
                                    </div>
                                    ${
                                      miscData.entries &&
                                      miscData.entries.length > 0
                                        ? `
                                        <div style="margin-top: 0.75rem;">
                                            <button type="button" 
                                                    onclick="toggleMiscHistory('${miscKey}')"
                                                    style="background: none; border: none; color: #856404; cursor: pointer; font-size: 0.875rem; text-decoration: underline; padding: 0;">
                                                ðŸ“‹ View Expense History (${
                                                  miscData.entries.length
                                                } ${
                                            miscData.entries.length === 1
                                              ? "entry"
                                              : "entries"
                                          })
                                            </button>
                                            <div id="misc-history-${miscKey}" style="display: none; margin-top: 0.5rem; padding: 0.75rem; background: rgba(255, 255, 255, 0.5); border-radius: 0.375rem; border: 1px solid #ffc107;">
                                                ${miscData.entries
                                                  .map(
                                                    (entry, idx) => `
                                                    <div style="display: flex; justify-content: space-between; padding: 0.25rem 0; border-bottom: 1px solid rgba(255, 193, 7, 0.3);">
                                                        <span style="color: #5a3e07; font-size: 0.875rem;">
                                                            <strong>$${entry.amount.toFixed(
                                                              2
                                                            )}</strong> - ${
                                                      entry.comment ||
                                                      "No description"
                                                    }
                                                        </span>
                                                        <span style="color: #6d4c0d; font-size: 0.75rem;">
                                                            ${new Date(
                                                              entry.timestamp
                                                            ).toLocaleString()}
                                                        </span>
                                                    </div>
                                                `
                                                  )
                                                  .join("")}
                                            </div>
                                        </div>
                                    `
                                        : ""
                                    }
                                </div>
                            </td>
                        </tr>
                    `;

          const totalWithMisc = period.totalAssigned + miscAmount;

          html += `
                                <tr class="totals-row">
                                    <td colspan="3"><strong>Subtotal</strong></td>
                                    <td><strong class="amount">$${totalWithMisc.toFixed(
                                      2
                                    )}</strong></td>
                                    <td colspan="3"></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                `;
        });

        // Add recommendations
        html += generateRecommendations(assignments, netCashFlow, totalDebt);

        html += `</div>`;

        resultsDiv.innerHTML = html;
      }

      function generateRecommendations(assignments, netCashFlow, totalDebt) {
        let html = '<div class="recommendations">';
        html += "<h3>ðŸ’¡ Recommendations for Debt Payoff Optimization</h3>";
        html += "<ul>";

        if (netCashFlow > 0) {
          // Find highest interest debt (approximated by balance/amount ratio)
          const debtBills = billsData.filter(
            (b) => b.balance > 0 && b.amount > 0
          );
          const highestInterest = debtBills.sort(
            (a, b) => b.balance / b.amount - a.balance / a.amount
          )[0];

          if (highestInterest) {
            html += `<li><strong>Apply surplus to ${
              highestInterest.name
            }:</strong> Add the $${netCashFlow.toFixed(
              2
            )} surplus to David payment of $${highestInterest.amount.toFixed(
              2
            )} to pay down the balance of $${highestInterest.balance.toLocaleString(
              "en-US",
              { minimumFractionDigits: 2 }
            )} faster.</li>`;
          }
        }

        // Check for overloaded pay periods
        assignments.forEach((period, index) => {
          if (period.totalAssigned > period.amount) {
            html += `<li><strong>Warning:</strong> Paycheck ${
              index + 1
            } is overallocated by $${(
              period.totalAssigned - period.amount
            ).toFixed(
              2
            )}. Consider negotiating payment dates or deferring lower-priority bills.</li>`;
          }
        });

        // Debt avalanche suggestion
        const highInterestDebts = billsData
          .filter((b) => b.balance > 1000 && b.category === "Credit Card")
          .sort((a, b) => b.balance - a.balance);

        if (highInterestDebts.length > 0) {
          html += `<li><strong>Debt Avalanche Strategy:</strong> Focus extra payments on ${
            highInterestDebts[0].name
          } ($${highInterestDebts[0].balance.toLocaleString("en-US", {
            minimumFractionDigits: 2,
          })} balance) while maintaining minimums on others.</li>`;
        }

        // Payment timing optimization
        html +=
          "<li><strong>Payment Timing:</strong> Bills are assigned to the last paycheck before their due date to maximize cash flow flexibility.</li>";

        // ACH reminder
        const achBills = billsData.filter((b) => b.ach && b.amount > 0);
        if (achBills.length > 0) {
          html += `<li><strong>ACH Reminder:</strong> You have ${achBills.length} bills set for automatic payment. Ensure funds are available 2-3 days before the due date.</li>`;
        }

        html += "</ul>";
        html += "</div>";

        return html;
      }

      // Submit misc amount and update bank balance permanently
      async function submitMiscAmount(miscKey) {
        const inputElement = document.getElementById(`misc-input-${miscKey}`);
        const commentElement = document.getElementById(
          `misc-comment-${miscKey}`
        );
        const newAmount = parseFloat(inputElement.value) || 0;
        const comment = commentElement.value.trim();

        if (newAmount === 0) {
          alert("Please enter an amount greater than 0.");
          return;
        }

        if (!comment) {
          if (!confirm("No description provided. Continue anyway?")) {
            return;
          }
        }

        // Parse the miscKey to get year, month, and paycheck index
        const parts = miscKey.split("-");
        const year = parseInt(parts[0]);
        const month = parseInt(parts[1]);
        const paycheckIndex = parseInt(parts[3]);

        // Get current misc expenses
        const data = await fetchBudgetData();
        const currentData = data.miscExpenses[miscKey] || {
          total: 0,
          entries: [],
        };

        // Create new entry
        const newEntry = {
          amount: newAmount,
          comment: comment || "No description",
          timestamp: new Date().toISOString(),
        };

        // Update the data structure
        const updatedData = {
          total: (currentData.total || 0) + newAmount,
          entries: [...(currentData.entries || []), newEntry],
        };

        // Save to API
        await saveBudgetData("miscExpense", {
          year,
          month,
          paycheckIndex,
          data: updatedData,
        });

        // Update cache immediately
        budgetDataCache.miscExpenses[miscKey] = updatedData;

        // Subtract the new amount from bank balance
        const currentBankBalance =
          parseFloat(document.getElementById("bankBalance").value) || 0;
        const newBankBalance = currentBankBalance - newAmount;
        document.getElementById("bankBalance").value =
          newBankBalance.toFixed(2);

        // Save the new bank balance to API
        await saveBudgetData("bankBalance", {
          value: newBankBalance.toFixed(2),
        });

        // Clear the input boxes
        inputElement.value = "0.00";
        commentElement.value = "";

        // Refresh cache from API to ensure we have latest data
        await refreshBudgetDataCache();

        // Recalculate and update displayed values
        calculateBudget();
      }

      // Toggle misc expense history visibility
      function toggleMiscHistory(miscKey) {
        const historyElement = document.getElementById(
          `misc-history-${miscKey}`
        );
        if (historyElement) {
          historyElement.style.display =
            historyElement.style.display === "none" ? "block" : "none";
        }
      }

      // Add deposit to bank balance
      async function addDeposit() {
        const depositAmount = prompt("Enter deposit amount:");

        if (depositAmount === null || depositAmount === "") {
          return; // User cancelled or entered nothing
        }

        const amount = parseFloat(depositAmount);

        if (isNaN(amount) || amount <= 0) {
          alert("Please enter a valid positive number.");
          return;
        }

        // Ask for deposit description
        const comment = prompt(
          "What is this deposit for? (e.g., Cash tips, Gift, Side income)"
        );

        if (comment === null) {
          return; // User cancelled
        }

        // Get current month/year
        const monthYearValue = document.getElementById("monthYear").value;
        const [year, month] = monthYearValue.split("-").map(Number);

        // Get current deposits data
        const data = await fetchBudgetData();
        const depositsKey = `${year}-${month}`;
        const currentData = data.deposits?.[depositsKey] || {
          total: 0,
          entries: [],
        };

        // Create new deposit entry
        const newEntry = {
          amount: amount,
          comment: comment || "No description",
          timestamp: new Date().toISOString(),
        };

        // Update deposits data structure
        const updatedData = {
          total: (currentData.total || 0) + amount,
          entries: [...(currentData.entries || []), newEntry],
        };

        // Save to API
        await saveBudgetData("deposit", {
          year,
          month,
          data: updatedData,
        });

        // Update cache immediately
        if (!budgetDataCache.deposits) {
          budgetDataCache.deposits = {};
        }
        budgetDataCache.deposits[depositsKey] = updatedData;

        // Get current bank balance
        const currentBankBalance =
          parseFloat(document.getElementById("bankBalance").value) || 0;

        // Add the deposit
        const newBankBalance = currentBankBalance + amount;
        document.getElementById("bankBalance").value =
          newBankBalance.toFixed(2);

        // Save the new bank balance to API
        await saveBudgetData("bankBalance", {
          value: newBankBalance.toFixed(2),
        });

        // Show confirmation
        alert(
          `âœ… Deposit of $${amount.toFixed(
            2
          )} added!\n${comment}\nNew balance: $${newBankBalance.toFixed(2)}`
        );

        // Refresh from API to ensure cache is in sync
        await refreshBudgetDataCache();

        // Recalculate and update displayed values
        calculateBudget();
      }

      // Update payment status and recalculate bank balance
      async function updatePaymentStatus(selectElement) {
        const billKey = selectElement.getAttribute("data-bill-key");
        const billAmount = parseFloat(
          selectElement.getAttribute("data-bill-amount")
        );
        const newStatus = selectElement.value;

        // Update data-status attribute to change color
        selectElement.setAttribute("data-status", newStatus);

        // Parse the billKey to get year, month, and bill name
        const parts = billKey.split("-");
        const year = parseInt(parts[0]);
        const month = parseInt(parts[1]);
        const billName = parts.slice(2).join("-");

        // Save status to API
        await saveBudgetData("paymentStatus", {
          year,
          month,
          billName,
          status: newStatus,
        });

        // Update local cache immediately
        budgetDataCache.paymentStatuses[billKey] = newStatus;

        // If status is REMOVE, trigger full re-render to hide the row
        if (newStatus === "REMOVE") {
          calculateBudget();
        } else {
          // Otherwise just update the displayed bank balance
          updateDisplayedBankBalance();
        }
      }

      // Calculate adjusted bank balance based on payment statuses
      function calculateAdjustedBankBalance() {
        const baseBankBalance =
          parseFloat(document.getElementById("bankBalance").value) || 0;
        const savedStatuses = budgetDataCache.paymentStatuses;

        let totalPaid = 0;

        // Get current month/year selection
        const monthYearInput = document.getElementById("monthYear").value;
        const [selectedYear, selectedMonth] = monthYearInput
          .split("-")
          .map(Number);

        // Build a map of split bills and their per-period amounts
        const splitBillsMap = {};
        const budgetItemsToSplit = billsData.filter(
          (bill) =>
            bill.category === "Budget" &&
            (bill.name === "Groceries" ||
              bill.name === "Lunch/Eating Out" ||
              bill.name === "Gas (2 Vehicles)")
        );

        // Get payday to calculate pay periods
        const DavidPaydayInput = document.getElementById("DavidPayday").value;
        const DavidPayday = new Date(DavidPaydayInput);
        const DavidPay = parseFloat(document.getElementById("DavidPay").value);
        const ClaudiaPay = parseFloat(
          document.getElementById("ClaudiaPay").value
        );

        // Get pay periods for the selected month to calculate split amounts
        const payPeriods = calculatePayPeriods(
          DavidPayday,
          selectedYear,
          selectedMonth,
          DavidPay,
          ClaudiaPay
        );
        const numPeriods = payPeriods.length;

        budgetItemsToSplit.forEach((bill) => {
          const amountPerPeriod = bill.amount / numPeriods;
          splitBillsMap[bill.name] = amountPerPeriod;
        });

        // Sum up all bills marked as PCL only (only deduct when cleared)
        Object.keys(savedStatuses).forEach((billKey) => {
          const status = savedStatuses[billKey];
          if (status === "PNC" || status === "PCL") {
            // Extract bill name from key (format: "year-month-billname" or "year-month-billname-periodIndex")
            const parts = billKey.split("-");
            const billName = parts.slice(2).join("-");

            // Check if this is a split bill with period index
            let actualBillName = billName;
            let hasPeriodIndex = false;

            // For split bills, the key includes the period index at the end
            // Example: "2025-1-Groceries-0", "2025-1-Groceries-1", etc.
            budgetItemsToSplit.forEach((bill) => {
              if (billName.startsWith(bill.name + "-")) {
                actualBillName = bill.name;
                hasPeriodIndex = true;
              }
            });

            // Find the bill in billsData or customBills
            let bill = billsData.find((b) => b.name === actualBillName);
            if (!bill) {
              // Check custom bills
              bill = budgetDataCache.customBills
                .filter((b) => !b.deleted)
                .find((b) => b.name === actualBillName);
            }

            if (bill) {
              // For split budget items, only subtract the per-period amount
              if (splitBillsMap[actualBillName]) {
                totalPaid += Math.abs(splitBillsMap[actualBillName]);
              } else {
                // For regular bills, subtract the full amount
                totalPaid += Math.abs(bill.amount);
              }
            }
          }
        });

        // Note: Misc expenses are now permanently subtracted from base balance
        // when submitted, so we don't subtract them here

        return baseBankBalance - totalPaid;
      }

      // Update the displayed bank balance in the summary card
      function updateDisplayedBankBalance() {
        const adjustedBalance = calculateAdjustedBankBalance();
        const baseBankBalance =
          parseFloat(document.getElementById("bankBalance").value) || 0;
        const totalPaid = baseBankBalance - adjustedBalance;

        // Find and update the bank balance display using a proper selector
        const labels = document.querySelectorAll(".summary-card .label");
        let bankBalanceCard = null;
        for (const label of labels) {
          if (label.textContent.includes("Current Checking Balance")) {
            bankBalanceCard = label;
            break;
          }
        }

        if (bankBalanceCard) {
          const valueElement = bankBalanceCard.nextElementSibling;
          if (valueElement) {
            valueElement.innerHTML = `$${adjustedBalance.toFixed(2)}`;

            // Add a subtitle showing the adjustment
            if (totalPaid > 0) {
              const subtitle = valueElement.nextElementSibling;
              if (subtitle && subtitle.style.fontSize === "0.75rem") {
                subtitle.innerHTML = `Base: $${baseBankBalance.toFixed(
                  2
                )} - Paid: $${totalPaid.toFixed(2)}`;
              } else {
                valueElement.insertAdjacentHTML(
                  "afterend",
                  `<div style="font-size: 0.75rem; color: #6c757d; margin-top: 0.25rem;">
                    Base: $${baseBankBalance.toFixed(
                      2
                    )} - Paid: $${totalPaid.toFixed(2)}
                  </div>`
                );
              }
            }
          }
        }

        // Recalculate budget to update projected balance
        calculateBudget();
      }

      // Update payday label based on selected date
      function updatePaydayLabel() {
        const paydayInput = document.getElementById("DavidPayday");
        const paydayLabel = document.getElementById("paydayLabel");
        const paydayWarning = document.getElementById("paydayWarning");

        if (!paydayInput.value) {
          paydayLabel.textContent = "Next Payday";
          paydayWarning.style.display = "none";
          return;
        }

        const selectedDate = new Date(paydayInput.value + "T00:00:00");
        const dayOfWeek = selectedDate.getDay(); // 0=Sunday, 1=Monday, 2=Tuesday, 3=Wednesday, 4=Thursday, 5=Friday, 6=Saturday

        if (dayOfWeek === 5) {
          // Friday - David's payday
          paydayLabel.textContent = "David's Next Payday (Friday - Biweekly)";
          paydayWarning.style.display = "none";
        } else if (dayOfWeek === 2) {
          // Tuesday - Claudia's payday
          paydayLabel.textContent =
            "Claudia's Next Payday (Tuesday - Biweekly)";
          paydayWarning.textContent =
            "âš ï¸ Note: This is Claudia's payday (Tuesday). Enter David's next Friday payday for accurate calculations.";
          paydayWarning.style.display = "block";
        } else {
          // Invalid day
          const days = [
            "Sunday",
            "Monday",
            "Tuesday",
            "Wednesday",
            "Thursday",
            "Friday",
            "Saturday",
          ];
          paydayLabel.textContent = "Next Payday";
          paydayWarning.textContent = `âš ï¸ Invalid payday: ${days[dayOfWeek]}. Please select David's Friday payday or Claudia's Tuesday payday.`;
          paydayWarning.style.display = "block";
        }
      }

      // Firefox month input fallback functions
      function checkMonthSupport(input) {
        // Check if browser supports type="month"
        if (input.type !== "month") {
          // Browser doesn't support month input (Firefox)
          document.getElementById("monthYear").style.display = "none";
          document.getElementById("monthYearFallback").style.display = "flex";

          // Sync initial values from main input to fallback
          const [year, month] = document
            .getElementById("monthYear")
            .value.split("-");
          document.getElementById("yearSelect").value = year;
          document.getElementById("monthSelect").value = month;
        }
      }

      function updateMonthYear() {
        // Called when fallback inputs change - sync to main input
        const year = document.getElementById("yearSelect").value;
        const month = document.getElementById("monthSelect").value;
        document.getElementById("monthYear").value = `${year}-${month}`;

        // Trigger recalculation
        calculateBudget();
      }

      // Auto-calculate on page load
      window.addEventListener("DOMContentLoaded", async () => {
        // Check if browser supports month input and show fallback if needed
        const monthInput = document.getElementById("monthYear");
        checkMonthSupport(monthInput);

        // Load and cache all budget data from API
        await refreshBudgetDataCache();

        // Load saved data from API
        const data = await fetchBudgetData();

        // Load saved adjustments first
        await loadSavedAdjustments();

        // Load saved bank balance from API
        if (data.bankBalance !== null) {
          document.getElementById("bankBalance").value = data.bankBalance;
        }

        // Update payday label on load
        updatePaydayLabel();

        // Then calculate budget
        calculateBudget();

        // Update label when payday changes
        document
          .getElementById("DavidPayday")
          .addEventListener("change", () => {
            updatePaydayLabel();
          });

        // Auto-recalculate when month/year changes
        document.getElementById("monthYear").addEventListener("change", () => {
          calculateBudget();
        });

        // Save bank balance when manually changed
        document
          .getElementById("bankBalance")
          .addEventListener("blur", async () => {
            const newBalance = document.getElementById("bankBalance").value;
            await saveBudgetData("bankBalance", { value: newBalance });
          });
      });
    </script>
  </body>
</html>
